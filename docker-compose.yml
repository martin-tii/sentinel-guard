name: sentinel-sandbox

x-sentinel-common: &sentinel-common
  build:
    context: .
    dockerfile: Dockerfile
  image: sentinel-guard:local
  read_only: true
  cap_drop:
    - ALL
  security_opt:
    - no-new-privileges:true
    - seccomp:./seccomp/sentinel-seccomp.json
  pids_limit: 256
  mem_limit: 512m
  cpus: 1.0
  tmpfs:
    - /tmp:rw,noexec,nosuid,size=64m
    - /run:rw,noexec,nosuid,size=16m
  volumes:
    - ./sandbox-workspace:/workspace:rw
  environment:
    HF_HOME: "/tmp/huggingface"
    TRANSFORMERS_CACHE: "/tmp/huggingface/transformers"
    HF_TOKEN: "${HF_TOKEN:-}"

services:
  opa:
    image: openpolicyagent/opa:latest
    profiles: ["proxied"]
    command:
      [
        "run",
        "--server",
        "--addr=0.0.0.0:8181",
        "--set=decision_logs.console=true",
        "/policies",
      ]
    ports:
      - "127.0.0.1:8181:8181"
    volumes:
      - ./policies/rego:/policies:ro
    networks:
      - sentinel-internal
      - external-egress

  sentinel-standard:
    <<: *sentinel-common
    profiles: ["standard"]
    command: ["python", "/opt/sentinel/tests/verify_fixes.py"]

  sentinel-strict:
    <<: *sentinel-common
    profiles: ["strict"]
    network_mode: "none"
    command: ["python", "/opt/sentinel/tests/verify_fixes.py"]

  sentinel-proxy:
    image: ubuntu/squid:latest
    profiles: ["proxied"]
    restart: unless-stopped
    networks:
      - sentinel-internal
      - external-egress
    volumes:
      - ./proxy/squid.conf:/etc/squid/squid.conf:ro
      - ./proxy/allowed-domains.txt:/etc/squid/allowed-domains.txt:ro

  sentinel-proxied:
    <<: *sentinel-common
    profiles: ["proxied"]
    depends_on:
      - sentinel-proxy
      - opa
    networks:
      - sentinel-internal
    environment:
      HTTP_PROXY: "http://sentinel-proxy:3128"
      HTTPS_PROXY: "http://sentinel-proxy:3128"
      NO_PROXY: "localhost,127.0.0.1,sentinel-proxy"
      SENTINEL_OPA_URL: "http://opa:8181"
    command: ["python", "/opt/sentinel/tests/verify_fixes.py"]

networks:
  sentinel-internal:
    internal: true
  external-egress:
